anaTupleDef: AnaProd/anaTupleDef.py
histTupleDef: Analysis/histTupleDef.py
analysis_import: Analysis.hh_bbww
analysis_cache_import: Analysis.tasks:AnalysisCacheTask:AnalysisCacheMergeTask
phys_model: Run3_Model
corrections:
  mu:
    stage: HistTuple
    columns:
      pfRelIso04_all: Muon_pfRelIso04_all
      tightId: Muon_tightId
      tkRelIso: Muon_tkRelIso
      highPtId: Muon_highPtId
      mediumId: Muon_mediumId
  trigger:
    stage: HistTuple
    mode: SF
  ele: { stage: HistTuple }
  muScaRe: { stage: HistTuple }
  eleES: { stage: AnaTuple }
  MC_Lumi_pu: { stage: AnaTuple }
  pu: { stages: [ AnaCache, AnaTuple ] }
  JEC: { stage: AnaTuple }
  JER:
    stage: AnaTuple
    apply_jet_horns_fix: true
  btag:
    stages: [ AnaTuple, HistTuple ]
    modes:
      AnaTuple: none # just load to define WP ID branches
      HistTuple: shape
    tagger: particleNet
    jetCollection: centralJet

treeName: "Events"

nPbPerFile: 2_000  # 2fb-1 per split data file
nEventsPerFile: 100_000  # 100k events per MC file

payload_producers:
  SingleLepHME:
    producers_module_name: Analysis.LegacyHMEProducer
    producer_name: HMEProducer
    channel: "SL"
    columns:
      - mass
      - valid
    dependencies:
    n_cpus: 4
    max_runtime: 30.0
    cmssw_env: True
  DoubleLepHME:
    producers_module_name: Analysis.LegacyHMEProducer
    producer_name: HMEProducer
    channel: "DL"
    columns:
      - mass
      - valid
    dependencies:
    n_cpus: 4
    max_runtime: 30.0
    cmssw_env: True
  DNN:
    producers_module_name: Analysis.DNN_Application
    producer_name: DNNProducer
    channel: "DL"
    version: "v24"
    columns:
      - M0_Signal
    dependencies:
    # - DoubleLepHME
    n_cpus: 4
    max_runtime: 2.0
    cmssw_env: False
    awkward_based: True
    uproot_stepsize: '50MB'
  # DNNParametric:
  #   producers_module_name: Analysis.DNN_Application
  #   producer_name: DNNProducer
  #   channel: "DL"
  #   version: "v35"
  #   columns:
  #     - M250_Signal
  #     - M260_Signal
  #     - M270_Signal
  #     - M280_Signal
  #     - M300_Signal
  #     - M350_Signal
  #     - M450_Signal
  #     - M550_Signal
  #     - M600_Signal
  #     - M650_Signal
  #     - M700_Signal
  #     - M800_Signal
  #     - M1000_Signal
  #     - M1200_Signal
  #     - M1400_Signal
  #     - M1600_Signal
  #     - M1800_Signal
  #     - M2000_Signal
  #     - M2500_Signal
  #     - M3000_Signal
  #     - M4000_Signal
  #     - M5000_Signal
  #   dependencies:
  #   # - DoubleLepHME # Currently DNN does not actually depend on HME yet
  #   n_cpus: 4
  #   max_runtime: 8.0
  #   cmssw_env: False
  #   awkward_based: True
  #   uproot_stepsize: '50MB'
  DNNParametric_DL_WithHME:
    producers_module_name: Analysis.DNN_Application
    producer_name: DNNProducer
    channel: "DL"
    version: "DoubleLepton_WithDeepHME"
    columns:
      - M250_Signal
      - M260_Signal
      - M270_Signal
      - M280_Signal
      - M300_Signal
      - M350_Signal
      - M450_Signal
      - M550_Signal
      - M600_Signal
      - M650_Signal
      - M700_Signal
      - M800_Signal
      - M1000_Signal
      - M1200_Signal
      - M1400_Signal
      - M1600_Signal
      - M1800_Signal
      - M2000_Signal
      - M2500_Signal
      - M3000_Signal
      - M4000_Signal
      - M5000_Signal
    dependencies:
      - DoubleLep_DeepHME
    n_cpus: 4
    max_runtime: 8.0
    cmssw_env: False
    awkward_based: True
    uproot_stepsize: '50MB'
  DNNParametric_DL_NoHME:
    producers_module_name: Analysis.DNN_Application
    producer_name: DNNProducer
    channel: "DL"
    version: "DoubleLepton_WithOutDeepHME"
    columns:
      # - M250_Signal
      # - M260_Signal
      # - M270_Signal
      # - M280_Signal
      # - M300_Signal
      # - M350_Signal
      # - M450_Signal
      # - M550_Signal
      # - M600_Signal
      # - M650_Signal
      # - M700_Signal
      # - M800_Signal
      # - M1000_Signal
      # - M1200_Signal
      # - M1400_Signal
      # - M1600_Signal
      # - M1800_Signal
      # - M2000_Signal
      # - M2500_Signal
      # - M3000_Signal
      # - M4000_Signal
      # - M5000_Signal

      # XtoYH doesn't have the same mass points
      - M300_Signal
      - M400_Signal
      - M500_Signal
      - M550_Signal
      - M600_Signal
      - M650_Signal
      - M700_Signal
      - M800_Signal
      - M900_Signal
      - M1000_Signal
    dependencies:
    # - DoubleLep_DeepHME
    n_cpus: 4
    max_runtime: 8.0
    cmssw_env: False
    awkward_based: True
    uproot_stepsize: '50MB'
  DNNParametric_SL_NoHME:
    producers_module_name: Analysis.DNN_Application
    producer_name: DNNProducer
    channel: "SL"
    version: "SingleLepton_WithOutDeepHME"
    columns:
      # - M250_Signal
      # - M260_Signal
      # - M270_Signal
      # - M280_Signal
      # - M300_Signal
      # - M350_Signal
      # - M450_Signal
      # - M550_Signal
      # - M600_Signal
      # - M650_Signal
      # - M700_Signal
      # - M800_Signal
      # - M1000_Signal
      # - M1200_Signal
      # - M1400_Signal
      # - M1600_Signal
      # - M1800_Signal
      # - M2000_Signal
      # - M2500_Signal
      # - M3000_Signal
      # - M4000_Signal
      # - M5000_Signal

      # XtoYH doesn't have the same mass points
      - M300_Signal
      - M400_Signal
      - M500_Signal
      - M550_Signal
      - M600_Signal
      - M650_Signal
      - M700_Signal
      - M800_Signal
      - M900_Signal
      - M1000_Signal
    dependencies:
    # - SingleLep_DeepHME
    n_cpus: 4
    max_runtime: 8.0
    cmssw_env: False
    awkward_based: True
    uproot_stepsize: '50MB'
  LinHMEDNN_DL:
    producers_module_name: Analysis.Linear_HME_DNN
    producer_name: LinHMEDNN
    channel: "DL"
    columns:
      # - linear_hme_dnn_m250
      # - linear_hme_dnn_m260
      # - linear_hme_dnn_m270
      # - linear_hme_dnn_m280
      # - linear_hme_dnn_m300
      # - linear_hme_dnn_m350
      # - linear_hme_dnn_m450
      # - linear_hme_dnn_m550
      # - linear_hme_dnn_m600
      # - linear_hme_dnn_m650
      # - linear_hme_dnn_m700
      # - linear_hme_dnn_m800
      # - linear_hme_dnn_m1000

      - linear_hme_dnn_m300
      - linear_hme_dnn_m400
      - linear_hme_dnn_m500
      - linear_hme_dnn_m550
      - linear_hme_dnn_m600
      - linear_hme_dnn_m650
      - linear_hme_dnn_m700
      - linear_hme_dnn_m800
      - linear_hme_dnn_m900
      - linear_hme_dnn_m1000
    dependencies:
      - DoubleLep_DeepHME
      - DNNParametric_DL_NoHME
    n_cpus: 4
    max_runtime: 2.0
    cmssw_env: False
    awkward_based: False
  LinHMEDNN_SL:
    producers_module_name: Analysis.Linear_HME_DNN
    producer_name: LinHMEDNN
    channel: "SL"
    columns:
      # - linear_hme_dnn_m250
      # - linear_hme_dnn_m260
      # - linear_hme_dnn_m270
      # - linear_hme_dnn_m280
      # - linear_hme_dnn_m300
      # - linear_hme_dnn_m350
      # - linear_hme_dnn_m450
      # - linear_hme_dnn_m550
      # - linear_hme_dnn_m600
      # - linear_hme_dnn_m650
      # - linear_hme_dnn_m700
      # - linear_hme_dnn_m800
      # - linear_hme_dnn_m1000

      - linear_hme_dnn_m300
      - linear_hme_dnn_m400
      - linear_hme_dnn_m500
      - linear_hme_dnn_m550
      - linear_hme_dnn_m600
      - linear_hme_dnn_m650
      - linear_hme_dnn_m700
      - linear_hme_dnn_m800
      - linear_hme_dnn_m900
      - linear_hme_dnn_m1000
    dependencies:
      - SingleLep_DeepHME
      - DNNParametric_SL_NoHME
    n_cpus: 4
    max_runtime: 2.0
    cmssw_env: False
    awkward_based: False
  DoubleLep_DeepHME:
    producers_module_name: Analysis.DeepHMEProducer
    producer_name: DeepHMEProducer
    channel: "DL"
    model_name: predict_quantiles3D_DL_v8
    return_errors: True
    columns:
      - mass
      - mass_error
      - Hbb_px
      - Hbb_py
      - Hbb_pz
      - Hbb_E
      - HVV_px
      - HVV_py
      - HVV_pz
      - HVV_E
    n_cpus: 4
    max_runtime: 8.0
    cmssw_env: False
    awkward_based: True
    uproot_stepsize: '50MB'
    dependencies:
  SingleLep_DeepHME:
    producers_module_name: Analysis.DeepHMEProducer
    producer_name: DeepHMEProducer
    channel: "SL"
    model_name: predict_quantiles3D_SL_v3
    return_errors: True
    columns:
      - mass
      - mass_error
      - Hbb_px
      - Hbb_py
      - Hbb_pz
      - Hbb_E
      - HVV_px
      - HVV_py
      - HVV_pz
      - HVV_E
    n_cpus: 4
    max_runtime: 8.0
    cmssw_env: False
    awkward_based: True
    uproot_stepsize: '50MB'
    dependencies:
  HMEinDNNBins:
    producers_module_name: Analysis.HMEinDNNBins
    producer_name: HMEinDNNBins
    dependencies:
      - SingleLep_DeepHME
      - DoubleLep_DeepHME
      - DNNParametric_DL_NoHME  # If these change remember to change the branch name in the python script
      - DNNParametric_SL_NoHME
    n_cpus: 4
    max_runtime: 2.0
    cmssw_env: False
    awkward_based: False
    virtual_payload: True  # Add support to avoid running payload as a cache, rather just running it in RAM live (if quick enough)
    masses:
      - 300
      - 600
      - 800
    bins:
      - [ 0p0, 0p2 ]
      - [ 0p2, 0p4 ]
      - [ 0p4, 0p6 ]
      - [ 0p6, 0p8 ]
      - [ 0p8, 1p0 ]
    columns:
      - HME_mass_DL_DNN_M300_0p0_0p2
      - HME_mass_DL_DNN_M300_0p2_0p4
      - HME_mass_DL_DNN_M300_0p4_0p6
      - HME_mass_DL_DNN_M300_0p6_0p8
      - HME_mass_DL_DNN_M300_0p8_1p0

      - HME_mass_DL_DNN_M600_0p0_0p2
      - HME_mass_DL_DNN_M600_0p2_0p4
      - HME_mass_DL_DNN_M600_0p4_0p6
      - HME_mass_DL_DNN_M600_0p6_0p8
      - HME_mass_DL_DNN_M600_0p8_1p0

      - HME_mass_DL_DNN_M800_0p0_0p2
      - HME_mass_DL_DNN_M800_0p2_0p4
      - HME_mass_DL_DNN_M800_0p4_0p6
      - HME_mass_DL_DNN_M800_0p6_0p8
      - HME_mass_DL_DNN_M800_0p8_1p0


      - HME_mass_SL_DNN_M300_0p0_0p2
      - HME_mass_SL_DNN_M300_0p2_0p4
      - HME_mass_SL_DNN_M300_0p4_0p6
      - HME_mass_SL_DNN_M300_0p6_0p8
      - HME_mass_SL_DNN_M300_0p8_1p0

      - HME_mass_SL_DNN_M600_0p0_0p2
      - HME_mass_SL_DNN_M600_0p2_0p4
      - HME_mass_SL_DNN_M600_0p4_0p6
      - HME_mass_SL_DNN_M600_0p6_0p8
      - HME_mass_SL_DNN_M600_0p8_1p0

      - HME_mass_SL_DNN_M800_0p0_0p2
      - HME_mass_SL_DNN_M800_0p2_0p4
      - HME_mass_SL_DNN_M800_0p4_0p6
      - HME_mass_SL_DNN_M800_0p6_0p8
      - HME_mass_SL_DNN_M800_0p8_1p0

region: All
region_default: SR
custom_regions: QCDRegions
custom_categories: ""
custom_subcategories: [ ]

# Option to scale signal by some factor in HistPlotTask.py
signal_plot_scale: 50

# This is for Analysis Selection
channelSelection:
  - e
  - mu
  - eE
  - eMu
  - muMu

# This is for Histogram Making
channels_to_consider:
  - e
  - mu
  - eE
  - eMu
  - muMu

channelDefinition:
  e: 1  # Second lepton doesn't exist
  mu: 2
  eE: 11
  eMu: 12
  muMu: 22

categories:
  - inclusive
  - recovery
  - res2b
  - boosted
  - baseline

QCDRegions:
  - OS_Iso
  - SS_Iso
  - OS_AntiIso
  - SS_AntiIso
  - ZVeto_OS_Iso
  - ZPeak_OS_Iso
  - mbbCR_Tight
  - mbbCR_AntiTight

boosted_categories: [ ]


triggers:
  e: [ singleEleWpTight ]
  mu: [ singleIsoMu ]
  eE: [ singleEleWpTight ]
  eMu: [ singleIsoMu ]
  muMu: [ singleIsoMu ]


application_regions:
  HLT_singleEleWpTight:
    region_name: SingleE_region
    region_cut: (true)
  HLT_singleIsoMu:
    region_name: SingleMu_region
    region_cut: (true)


var_only_boosted: [ ]

unc_to_not_consider_boosted: [ ]

uncs_to_exclude:
  Run3_2022: [ ]
  Run3_2022EE: [ ]
  Run3_2023: [ ]
  Run3_2023BPix: [ ]

storeExtraJets: False
scales:
  - Up
  - Down
deepTauVersion: 2p1
met_type: "PuppiMET"

# DNN Inputs
variables:
  - lep1_pt
  - lep1_eta
  - lep1_phi
  - lep1_mass

  - lep2_pt
  - lep2_eta
  - lep2_phi
  - lep2_mass

  - PuppiMET_pt
  - PuppiMET_phi

  - bjet1_pt
  - bjet1_eta
  - bjet1_phi
  - bjet1_mass
  - bjet1_btagPNetB

  - bjet2_pt
  - bjet2_eta
  - bjet2_phi
  - bjet2_mass
  - bjet2_btagPNetB

  - fatbjet1_pt
  - fatbjet1_eta
  - fatbjet1_phi
  - fatbjet1_mass
  - fatbjet1_XbbVsQCD

  - bb_mass_PNetRegPtRawCorr_PNetRegPtRawCorrNeutrino

  - HT
  - dR_dilep
  - dR_dibjet
  - dR_dilep_dibjet
  - dR_dilep_dijet
  - dPhi_lep1_lep2
  - dPhi_jet1_jet2
  - dPhi_MET_dilep
  - dPhi_MET_dibjet
  - MT
  - MT2_ll
  - MT2_bb
  - MT2_blbl
  - ll_mass
  - CosTheta_bb

  - lep1_Muon_pfRelIso04_all
  - lep2_Muon_pfRelIso04_all
  - lep1_Electron_pfRelIso03_all
  - lep2_Electron_pfRelIso03_all
  - mT_fix

  # # High Level Single Lepton
  # - SingleLep_DeepHME_mass
  # - SingleLep_DeepHME_mass_error

  # - LinHMEDNN_SL_linear_hme_dnn_m300
  # - LinHMEDNN_SL_linear_hme_dnn_m400
  # - LinHMEDNN_SL_linear_hme_dnn_m500
  # - LinHMEDNN_SL_linear_hme_dnn_m550
  # - LinHMEDNN_SL_linear_hme_dnn_m600
  # - LinHMEDNN_SL_linear_hme_dnn_m650
  # - LinHMEDNN_SL_linear_hme_dnn_m700
  # - LinHMEDNN_SL_linear_hme_dnn_m800
  # - LinHMEDNN_SL_linear_hme_dnn_m900
  # - LinHMEDNN_SL_linear_hme_dnn_m1000

  # # High Level Double Lepton
  # - DoubleLep_DeepHME_mass
  # - DoubleLep_DeepHME_mass_error

  # - LinHMEDNN_DL_linear_hme_dnn_m300
  # - LinHMEDNN_DL_linear_hme_dnn_m400
  # - LinHMEDNN_DL_linear_hme_dnn_m500
  # - LinHMEDNN_DL_linear_hme_dnn_m550
  # - LinHMEDNN_DL_linear_hme_dnn_m600
  # - LinHMEDNN_DL_linear_hme_dnn_m650
  # - LinHMEDNN_DL_linear_hme_dnn_m700
  # - LinHMEDNN_DL_linear_hme_dnn_m800
  # - LinHMEDNN_DL_linear_hme_dnn_m900
  # - LinHMEDNN_DL_linear_hme_dnn_m1000

  # # These can be done after HistTuple
  # - HMEinDNNBins_HME_mass_DL_DNN_M350_0p0_0p2
  # - HMEinDNNBins_HME_mass_DL_DNN_M350_0p2_0p4
  # - HMEinDNNBins_HME_mass_DL_DNN_M350_0p4_0p6
  # - HMEinDNNBins_HME_mass_DL_DNN_M350_0p6_0p8
  # - HMEinDNNBins_HME_mass_DL_DNN_M350_0p8_1p0

  # - HMEinDNNBins_HME_mass_DL_DNN_M550_0p0_0p2
  # - HMEinDNNBins_HME_mass_DL_DNN_M550_0p2_0p4
  # - HMEinDNNBins_HME_mass_DL_DNN_M550_0p4_0p6
  # - HMEinDNNBins_HME_mass_DL_DNN_M550_0p6_0p8
  # - HMEinDNNBins_HME_mass_DL_DNN_M550_0p8_1p0

  # - HMEinDNNBins_HME_mass_DL_DNN_M300_0p0_0p2
  # - HMEinDNNBins_HME_mass_DL_DNN_M300_0p2_0p4
  # - HMEinDNNBins_HME_mass_DL_DNN_M300_0p4_0p6
  # - HMEinDNNBins_HME_mass_DL_DNN_M300_0p6_0p8
  # - HMEinDNNBins_HME_mass_DL_DNN_M300_0p8_1p0

  # - HMEinDNNBins_HME_mass_DL_DNN_M600_0p0_0p2
  # - HMEinDNNBins_HME_mass_DL_DNN_M600_0p2_0p4
  # - HMEinDNNBins_HME_mass_DL_DNN_M600_0p4_0p6
  # - HMEinDNNBins_HME_mass_DL_DNN_M600_0p6_0p8
  # - HMEinDNNBins_HME_mass_DL_DNN_M600_0p8_1p0


  # - HMEinDNNBins_HME_mass_DL_DNN_M800_0p0_0p2
  # - HMEinDNNBins_HME_mass_DL_DNN_M800_0p2_0p4
  # - HMEinDNNBins_HME_mass_DL_DNN_M800_0p4_0p6
  # - HMEinDNNBins_HME_mass_DL_DNN_M800_0p6_0p8
  # - HMEinDNNBins_HME_mass_DL_DNN_M800_0p8_1p0
